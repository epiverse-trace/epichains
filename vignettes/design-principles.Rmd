---
title: "Design Principles for {epichains}"
subtitle: "An R package for simulating, handling, and analysing transmission chains in R"
pkgdown:
  as_is: true
bibliography: references.json
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design Principles for {epichains}}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette outlines the design decisions that have been taken during the development of the {epichains} R package, and provides some of the reasoning, and possible pros and cons of each decision.

This document is primarily intended to be read by those interested in understanding the code within the package and for potential package contributors.

## Scope

{epichains} aims to provide four three functionalities:

* Branching process models for simulating transmission chains using the
`simulate_tree()` and `simulate_summary()` functions,
* Modelling of the offspring distribution using shipped mixture distributions
like `rborel()`.
* Estimation of the likelihood of
observing transmission chains of given sizes or lengths. This can be achieved
in two ways:
  - Closed form or analytical likelihoods that take the form <distribution>_<chain_statistic_type_ll>, for example,
`gborel_size_ll()` and `pois_length_ll()`.
  - Simulation using `offspring_ll()`.

## Input/Output/Interoperability

`simulate_tree()` returns an `<epichains_tree>` object that stores both
the simulated output and parameter values used to achieve the simulation.
`print()` and `summary()` methods are implemented for the `<epichains_tree>`
class to help return insightful output based on the simulated transmission
chains. Future support will be provided for `<epidist>` objects from the
{epiparameter} package to allow for interoperability. Storing
inputs and outputs in the `<epichains_tree>` object eases the extra work
needed to be done by the user to set up scenario analyses.

`simulate_summary()` returns a vector.

## Design decisions

### `<epichains_tree>` class

* Objects of this class have attributes to store simulation
  metadata (all inputs, including `statistic`,`stat_max`,
  `offspring_dist`, `generation_time`, `pop_size`, e.t.c.,).

* Columns of `<epichains_tree>`: 
  * `generation_time` (numeric)
  * `infector_id` (factor) 
  * `infectee_id` (factor) 
  * `generation` (integer)

### Methods

* `print.epichains_tree()`: function to format and pretty 
print `<epichains_tree>` objects.

* `summary.epichains_tree()`: function to summarise an
`<epichains_tree>` into the eventual outcome of the chain statistic simulated,
and with the same length as the index cases. All values above `stat_max`
are set to `Inf` with the same logic as in `simulate_summary()`.

* `aggregate.epichains_tree()`: function to aggregate the simulated
chains into cases by "generation" or "time", if it was simulated.

## Dependencies

* Input validation:
  - [checkmate](https://github.com/mllg/checkmate/): exports many `test_*()`,
  `check_*()` and `assert_*()` functions and is available on CRAN.

## Development journey

{epichains} is a successor to the [bpmodels](https://github.com/epiverse-trace/bpmodels) #nolint package, which had the same functionality but not structured in an
object-oriented manner. The package was developed to provide a more structured
and object-oriented approach to simulating and handling transmission
chains in R.
As far as we know, below are the existing R packages for simulating and
handling transmission chains. 

* [bpmodels](https://github.com/epiverse-trace/bpmodels): provides methods 
for analysing the size and length of transmission chains from branching 
process models. {bpmodels} is the predecessor of {epichains}.

* [earlyR](https://github.com/reconhub/earlyR): estimates the reproduction 
number (R), in the early stages of an outbreak. The model requires a 
specified serial interval distribution, characterised by the mean and 
standard deviation of the (Gamma) distribution, and data on daily disease 
incidence, including only confirmed and probable cases.

* [projections](https://github.com/reconhub/projections): uses data on daily 
incidence, the serial interval (time between onsets of infectors and 
infectees) and the reproduction number to simulate plausible epidemic 
trajectories and project future incidence. It relies on a branching process 
where daily incidence follows a Poisson or a Negative Binomial distribution
governed by a force of infection.

* [epicontacts](https://github.com/reconhub/epicontacts): handling, 
analysing, and visualizing transmission chains and contact tracing 
data/linelists.

* [simulacr](https://github.com/reconhub/simulacr): simulates outbreaks 
for specified values of reproduction number, incubation period, duration 
of infectiousness, and optionally reporting delays. Outputs a linelist 
stored as a `data.frame` with the class `outbreak`, including information
on transmission chains; the output can be converted to `epicontacts` 
objects for visualisation, and plotted using plot(...).

* [ringbp](https://github.com/epiforecasts/ringbp): a branching process 
model, parameterised to the 2019-nCoV outbreak, and used to quantify 
the potential effectiveness of contact tracing and isolation of cases.

* [covidhm](https://github.com/biouea/covidhm): code for simulating 
COVID-19 dynamics in a range of scenarios across a real-world social 
network. Model is conceptually based on `ringbp`.

* [outbreakr](https://sites.google.com/site/therepiproject/r-pac/outbreaker): 
implements a Bayesian approach for reconstructing outbreak data from 
pathogen genome sequences. It also implements a tool for outbreak simulation.

* [outbreakr2](https://github.com/reconhub/outbreaker2): a Bayesian 
framework for integrating epidemiological and genetic data to reconstruct 
transmission trees of densely sampled outbreaks. It re-implements, 
generalises and replaces the model of outbreaker, and uses a modular
approach which enables fine customisation of priors, likelihoods 
and parameter movements.

* [o2geosocial](https://github.com/alxsrobert/o2geosocial): integrates
geographical and social contact data to reconstruct transmission chains. 
It combines the age group, location, onset date and genotype of cases 
to infer their import status, and their likely infector.

* [nosoi](https://github.com/slequime/nosoi): simulates agent-based 
transmission chains by taking into account the influence of multiple 
variables on the transmission process (e.g. dual-host systems 
(such as arboviruses), within-host viral dynamics, transportation, 
population structure), alone or taken together, to create complex 
but relatively intuitive epidemiological simulations.

* [TransPhylo](https://xavierdidelot.github.io/TransPhylo/index.html):
reconstructs infectious disease transmission using genomic data.
